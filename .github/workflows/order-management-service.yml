name: Master - CI/CD
on:
  push:
    branches:
      - main
      - 'playground/workflow-for-omg-service'
jobs:
  prepare_modified_files:
    name: üóÉ Modified modules
    runs-on: ubuntu-latest
    steps:
      - name: üö™ Checkout source code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: üìñ Read config file
        id: config
        run: echo "config=$(jq -c . ./.github/config/modules.json)" >> $GITHUB_OUTPUT

      - name: üëÄ Get modified modules
        id: check_modified
        uses: ./.github/actions/prepare_modified
        with:
          config: ${{ steps.config.outputs.config }}
          terraform_path: 'terraform/**'
          db_migration_path: 'db-migration/**'
          common_paths: "src/**, public/**"
    
    outputs:
      modules: ${{ steps.check_modified.outputs.modified_modules }}
      is_terraform_changed: ${{ steps.check_modified.outputs.terraform == 'true' }}
      is_db_migration_changed: ${{ steps.check_modified.outputs.db_migration == 'true' }}

  terraform_apply:
    name: ‚öôÔ∏è Apply terraform changes
    needs: prepare_modified_files
    runs-on: ubuntu-latest
    if: ${{ needs.prepare_modified_files.outputs.is_terraform_changed == 'true' }}
    steps:
      - run: echo "I am running cause terraform was changed"

  db_migration:
    name: üíæ Apply DB Migration
    needs: prepare_modified_files
    runs-on: ubuntu-latest
    if: ${{ needs.prepare_modified_files.outputs.is_db_migration_changed == 'true' }}
    steps:
      - run: echo "I am running cause DB Migration was changed"
    
  modules:
    name: Deploy modules ${{ matrix.modules.name }}
    runs-on: ubuntu-latest
    needs: prepare_modified_files
    strategy:
      matrix:
        modules: ${{ fromJSON(needs.prepare_modified_files.outputs.modules) }}
    steps:
      - run: echo ${{ matrix.modules.name }}
    